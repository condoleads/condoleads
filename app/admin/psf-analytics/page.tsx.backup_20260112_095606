// app/admin/psf-analytics/page.tsx

import { createClient } from '@/lib/supabase/server';
import PSFAnalyticsDashboard from './psf-dashboard';

export default async function PSFAnalyticsPage() {
  const supabase = await createClient();

  // Get summary stats
  const { data: stats } = await supabase
    .from('mls_listings')
    .select('calculated_sqft, sqft_method, price_per_sqft, close_date')
    .eq('standard_status', 'Closed')
    .not('close_price', 'is', null);

  const totalSold = stats?.length || 0;
  const withPSF = stats?.filter((s) => s.price_per_sqft)?.length || 0;
  const methodBreakdown = {
    exact: stats?.filter((s) => s.sqft_method === 'exact')?.length || 0,
    midpoint: stats?.filter((s) => s.sqft_method === 'midpoint')?.length || 0,
    fallback: stats?.filter((s) => s.sqft_method === 'fallback')?.length || 0,
    pending: totalSold - withPSF,
  };

  return (
    <div className="p-6 max-w-7xl mx-auto">
      <h1 className="text-2xl font-bold mb-6">PSF Analytics Dashboard</h1>

      <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
        <StatCard label="Total Sold Listings" value={totalSold} />
        <StatCard label="With PSF Calculated" value={withPSF} />
        <StatCard label="Pending Calculation" value={methodBreakdown.pending} />
        <StatCard 
          label="Data Quality" 
          value={totalSold > 0 ? `${Math.round((withPSF / totalSold) * 100)}%` : '0%'} 
        />
      </div>

      <div className="grid grid-cols-3 gap-4 mb-8">
        <MethodCard method="Exact" count={methodBreakdown.exact} color="green" />
        <MethodCard method="Midpoint" count={methodBreakdown.midpoint} color="yellow" />
        <MethodCard method="Fallback" count={methodBreakdown.fallback} color="red" />
      </div>

      <PSFAnalyticsDashboard />
    </div>
  );
}

function StatCard({ label, value }: { label: string; value: string | number }) {
  return (
    <div className="bg-white border rounded-lg p-4 shadow-sm">
      <p className="text-sm text-gray-500">{label}</p>
      <p className="text-2xl font-semibold">{value}</p>
    </div>
  );
}

function MethodCard({ method, count, color }: { method: string; count: number; color: string }) {
  const colors = {
    green: 'bg-green-100 border-green-300 text-green-800',
    yellow: 'bg-yellow-100 border-yellow-300 text-yellow-800',
    red: 'bg-red-100 border-red-300 text-red-800',
  };
  
  return (
    <div className={`border rounded-lg p-4 ${colors[color as keyof typeof colors]}`}>
      <p className="text-sm font-medium">{method}</p>
      <p className="text-xl font-bold">{count}</p>
    </div>
  );
}
