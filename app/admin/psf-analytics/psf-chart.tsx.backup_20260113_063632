// app/admin/psf-analytics/psf-chart.tsx

'use client';

import { useMemo } from 'react';

interface DataPoint {
  period_year: number;
  period_month: number;
  all_avg_psf: number | null;
  all_sample_size: number;
  parking_avg_psf: number | null;
  no_parking_avg_psf: number | null;
}

interface Props {
  data: DataPoint[];
  type: 'sale' | 'lease';
  title?: string;
}

export default function PSFChart({ data, type, title }: Props) {
  const chartData = useMemo(() => {
    if (!data || data.length === 0) return [];

    return data
      .filter(d => d.all_avg_psf !== null)
      .map(d => ({
        month: `${d.period_year}-${d.period_month.toString().padStart(2, '0')}`,
        avgPsf: d.all_avg_psf,
        parkingPsf: d.parking_avg_psf,
        noParkingPsf: d.no_parking_avg_psf,
        sampleSize: d.all_sample_size,
      }))
      .sort((a, b) => a.month.localeCompare(b.month));
  }, [data]);

  if (chartData.length === 0) {
    return (
      <div className="bg-gray-50 border rounded-lg p-8 text-center text-gray-500">
        No data available for chart
      </div>
    );
  }

  // Calculate chart dimensions
  const maxPsf = Math.max(...chartData.map(d => d.avgPsf || 0));
  const minPsf = Math.min(...chartData.map(d => d.avgPsf || 0));
  const range = maxPsf - minPsf || 1;
  const padding = range * 0.1;

  const chartHeight = 250;
  const chartWidth = Math.max(600, chartData.length * 40);

  const getY = (psf: number) => {
    return chartHeight - ((psf - minPsf + padding) / (range + padding * 2)) * chartHeight;
  };

  // Generate path for line chart
  const linePath = chartData
    .map((d, i) => {
      const x = (i / (chartData.length - 1)) * (chartWidth - 60) + 30;
      const y = getY(d.avgPsf || 0);
      return `${i === 0 ? 'M' : 'L'} ${x} ${y}`;
    })
    .join(' ');

  const psfLabel = type === 'sale' ? '$/sqft' : '$/sqft/mo';
  const avgPsfDisplay = Math.round(chartData.reduce((sum, d) => sum + (d.avgPsf || 0), 0) / chartData.length);

  return (
    <div className="bg-white border rounded-lg p-4">
      {title && <h3 className="font-semibold mb-4">{title}</h3>}
      
      {/* Summary stats */}
      <div className="flex gap-6 mb-4 text-sm">
        <div>
          <span className="text-gray-500">Avg PSF:</span>{' '}
          <span className="font-semibold">${avgPsfDisplay}{type === 'lease' ? '/mo' : ''}</span>
        </div>
        <div>
          <span className="text-gray-500">Range:</span>{' '}
          <span className="font-semibold">${Math.round(minPsf)} - ${Math.round(maxPsf)}</span>
        </div>
        <div>
          <span className="text-gray-500">Months:</span>{' '}
          <span className="font-semibold">{chartData.length}</span>
        </div>
      </div>

      {/* Chart */}
      <div className="overflow-x-auto">
        <svg width={chartWidth} height={chartHeight + 40} className="min-w-full">
          {/* Y-axis labels */}
          <text x="5" y="15" className="text-xs fill-gray-500">${Math.round(maxPsf + padding)}</text>
          <text x="5" y={chartHeight / 2} className="text-xs fill-gray-500">${Math.round((maxPsf + minPsf) / 2)}</text>
          <text x="5" y={chartHeight - 5} className="text-xs fill-gray-500">${Math.round(minPsf - padding)}</text>

          {/* Grid lines */}
          <line x1="30" y1="0" x2="30" y2={chartHeight} stroke="#e5e7eb" strokeWidth="1" />
          <line x1="30" y1={chartHeight} x2={chartWidth} y2={chartHeight} stroke="#e5e7eb" strokeWidth="1" />
          
          {/* Horizontal grid */}
          {[0.25, 0.5, 0.75].map(pct => (
            <line
              key={pct}
              x1="30"
              y1={chartHeight * pct}
              x2={chartWidth}
              y2={chartHeight * pct}
              stroke="#f3f4f6"
              strokeWidth="1"
            />
          ))}

          {/* Line chart */}
          <path d={linePath} fill="none" stroke="#3b82f6" strokeWidth="2" />

          {/* Data points */}
          {chartData.map((d, i) => {
            const x = (i / (chartData.length - 1)) * (chartWidth - 60) + 30;
            const y = getY(d.avgPsf || 0);
            return (
              <g key={d.month}>
                <circle cx={x} cy={y} r="4" fill="#3b82f6" />
                {/* Show every 3rd label to avoid crowding */}
                {i % 3 === 0 && (
                  <text
                    x={x}
                    y={chartHeight + 20}
                    textAnchor="middle"
                    className="text-xs fill-gray-500"
                  >
                    {d.month.substring(2)}
                  </text>
                )}
              </g>
            );
          })}
        </svg>
      </div>

      {/* Legend */}
      <div className="flex gap-4 mt-4 text-xs text-gray-500">
        <div className="flex items-center gap-1">
          <div className="w-3 h-3 bg-blue-500 rounded-full"></div>
          <span>Avg {psfLabel}</span>
        </div>
      </div>
    </div>
  );
}
