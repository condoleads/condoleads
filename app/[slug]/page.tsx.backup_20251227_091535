import { notFound } from 'next/navigation'
import { headers } from 'next/headers'
import { isPropertySlug, parsePropertySlug } from '@/lib/utils/slugs'
import BuildingPage, { generateMetadata as generateBuildingMetadata } from './BuildingPage'
import DevelopmentPage, { generateDevelopmentMetadata } from './DevelopmentPage'
import PropertyPage from '../property/[id]/page'
import { supabase } from '@/lib/supabase/client'

export async function generateMetadata({ params }: { params: { slug: string } }) {
  const headersList = headers()
  const host = headersList.get('host') || ''
  const { createClient } = await import('@/lib/supabase/server')
  const serverSupabase = createClient()
  
  // Helper to get siteName from host
  const getSiteName = async (): Promise<string> => {
    if (!host.includes('condoleads.ca') && !host.includes('localhost') && !host.includes('vercel.app')) {
      const cleanDomain = host.replace(/^www\./, '')
      const { data: agent } = await serverSupabase
        .from('agents')
        .select('site_title')
        .eq('custom_domain', cleanDomain)
        .eq('is_active', true)
        .single()
      return agent?.site_title || 'CondoLeads'
    } else if (host.includes('.condoleads.ca')) {
      const subdomain = host.split('.')[0]
      const { data: agent } = await serverSupabase
        .from('agents')
        .select('site_title')
        .eq('subdomain', subdomain)
        .eq('is_active', true)
        .single()
      return agent?.site_title || 'CondoLeads'
    }
    return 'CondoLeads'
  }
  
  // Check if it's a property slug first
  if (isPropertySlug(params.slug)) {
    const { mlsNumber } = parsePropertySlug(params.slug)
    if (mlsNumber) {
      const { data: listing, error } = await serverSupabase
        .from('mls_listings')
        .select('id, unparsed_address, list_price, bedrooms_total, bathrooms_total, transaction_type, building_id, unit_number')
        .ilike('listing_key', mlsNumber)
        .single()
      
      console.log('Property metadata debug:', { mlsNumber, listing: listing?.id, error: error?.message })
      
      if (listing) {
        const siteName = await getSiteName()
        
        // Get building name
        const { data: building } = await serverSupabase
          .from('buildings')
          .select('building_name')
          .eq('id', listing.building_id)
          .single()
        
        const price = listing.list_price ? `$${listing.list_price.toLocaleString()}` : ''
        const beds = listing.bedrooms_total ? `${listing.bedrooms_total} Bed` : ''
        const unit = listing.unit_number ? `Unit ${listing.unit_number}` : ''
        
        const titleParts = [listing.unparsed_address, unit, building?.building_name, price, beds, siteName].filter(Boolean)
        const title = titleParts.join(' | ')
        const description = `${beds} condo at ${listing.unparsed_address}${building ? ` in ${building.building_name}` : ''}. ${price}. View photos and schedule a showing.`
        
        return { title, description }
      }
    }
    return { title: 'Property Not Found' }
  }
  
  // Check if it's a development slug
  const { data: development } = await serverSupabase
    .from('developments')
    .select('id, name, slug')
    .eq('slug', params.slug)
    .single()
  
  if (development) {
    return generateDevelopmentMetadata(development)
  }
  
  // Fall back to building metadata
  return generateBuildingMetadata({ params })
}

export default async function DynamicSlugPage({
  params
}: {
  params: { slug: string }
}) {
  // Property URL: /101-charles-st-e-unit-2503-c7351578
  if (isPropertySlug(params.slug)) {
    const { mlsNumber } = parsePropertySlug(params.slug)
    if (!mlsNumber) {
      notFound()
    }

    // Lookup property ID by MLS number
    const { data: listing } = await supabase
      .from('mls_listings')
      .select('id')
      .eq('listing_key', mlsNumber)
      .single()

    if (!listing) {
      notFound()
    }

    // Render property page with the found ID
    return <PropertyPage params={{ id: listing.id }} />
  }

  // Check if it's a development slug
  const { data: development } = await supabase
    .from('developments')
    .select('id, name, slug')
    .eq('slug', params.slug)
    .single()

  if (development) {
    // Development URL: /playground-condos-30-50-ordnance-st-toronto
    return <DevelopmentPage params={params} development={development} />
  }

  // Building URL: /x2-condos-101-charles-st-e-toronto
  return <BuildingPage params={params} />
}