import { notFound } from 'next/navigation'
import { headers } from 'next/headers'
import { supabase } from '@/lib/supabase/client'
import { createClient } from '@/lib/supabase/server'
import { getDisplayAgentForDevelopment, isCustomDomain } from '@/lib/utils/agent-detection'
import { AgentCard } from '@/components/AgentCard'
import Link from 'next/link'
import DevelopmentListings from './components/DevelopmentListings'
import DevelopmentSEO from './components/DevelopmentSEO'
import Breadcrumb from '@/components/Breadcrumb'

interface DevelopmentPageProps {
  params: { slug: string }
  development: { id: string; name: string; slug: string }
}

export async function generateDevelopmentMetadata(development: { id: string; name: string; slug: string }) {
  const headersList = headers()
  const host = headersList.get('host') || ''
  const serverSupabase = createClient()
  
  // Fetch agent branding based on host
  let agentBranding: { site_title: string | null; site_tagline: string | null; og_image_url: string | null } | null = null
  
  if (isCustomDomain(host)) {
    const cleanDomain = host.replace(/^www\./, '')
    const { data } = await serverSupabase
      .from('agents')
      .select('site_title, site_tagline, og_image_url')
      .eq('custom_domain', cleanDomain)
      .eq('is_active', true)
      .single()
    agentBranding = data
  } else {
    const parts = host.split('.')
    if (parts.length >= 3 && parts[1] === 'condoleads') {
      const subdomain = parts[0]
      const { data } = await serverSupabase
        .from('agents')
        .select('site_title, site_tagline, og_image_url')
        .eq('subdomain', subdomain)
        .eq('is_active', true)
        .single()
      agentBranding = data
    }
  }
  
  const siteName = agentBranding?.site_title || 'CondoLeads'
  const ogImage = agentBranding?.og_image_url || '/og-image.jpg'
  
  // Get buildings with addresses
  const { data: buildings } = await serverSupabase
    .from('buildings')
    .select('id, canonical_address')
    .eq('development_id', development.id)
  
  const buildingCount = buildings?.length || 0
  const addresses = buildings?.map(b => b.canonical_address).filter(Boolean).join(', ') || ''
  
  const title = `${development.name} | ${addresses} | ${siteName}`
  const description = `Explore ${development.name} at ${addresses}. ${buildingCount} buildings with condos for sale and rent. View floor plans, amenities, and market insights.`
  
  return {
    title,
    description,
    openGraph: {
      title,
      description,
      url: `https://${host}/${development.slug}`,
      siteName: siteName,
      locale: 'en_CA',
      type: 'website',
      images: [{ url: ogImage, width: 1200, height: 630, alt: development.name }],
    },
    twitter: {
      card: 'summary_large_image',
      title,
      description,
      images: [ogImage],
    },
  }
}

export default async function DevelopmentPage({ params, development }: DevelopmentPageProps) {
  const headersList = headers()
  const host = headersList.get('host') || ''
  const serverSupabase = createClient()
  const { displayAgent, isTeamSite } = await getDisplayAgentForDevelopment(host, development.id)
  
  if (!displayAgent) {
    notFound()
  }
  const agent = displayAgent

  const { data: buildings } = await serverSupabase
    .from('buildings')
    .select('*')
    .eq('development_id', development.id)
    .order('building_name')

  if (!buildings || buildings.length === 0) { notFound() }

  const buildingIds = buildings.map((b: any) => b.id)

  const { data: allListings } = await serverSupabase
    .from('mls_listings')
    .select('*, media (media_url, media_type, variant_type, order_number, preferred_photo_yn)')
    .in('building_id', buildingIds)
    .order('list_price', { ascending: false })

  const forSaleActive = (allListings || []).filter((l: any) => l.transaction_type === 'For Sale' && l.standard_status === 'Active')
  const forLeaseActive = (allListings || []).filter((l: any) => l.transaction_type === 'For Lease' && l.standard_status === 'Active')
  const soldListings = (allListings || []).filter((l: any) => l.transaction_type === 'For Sale' && l.standard_status === 'Closed')
  const leasedListings = (allListings || []).filter((l: any) => l.transaction_type === 'For Lease' && l.standard_status === 'Closed')
  const totalUnits = buildings.reduce((sum: number, b: any) => sum + (b.total_units || 0), 0)
  const addresses = buildings.map((b: any) => b.canonical_address).join(' & ')

  const formatPrice = (price: number) => {
    if (price >= 1000000) return `$${(price / 1000000).toFixed(2)}M`
    return `$${(price / 1000).toFixed(0)}K`
  }

  const getListingPhoto = (listing: any) => {
    const photos = listing.media?.filter((m: any) => m.variant_type === 'large') || []
    return photos[0]?.media_url || '/placeholder-unit.jpg'
  }

  return (
    <>
      <script
        dangerouslySetInnerHTML={{
          __html: `window.__AGENT_DATA__ = ${JSON.stringify({
            id: agent.id,
            full_name: agent.full_name,
            email: agent.email,
            phone: agent.cell_phone,
            brokerage_name: agent.brokerage_name,
            brokerage_address: agent.brokerage_address,
            title: agent.title,
            siteName: agent.site_title || agent.full_name,
            siteTagline: agent.site_tagline || 'Toronto Condo Specialist',
            ogImageUrl: agent.og_image_url,
            buildingName: development.name,
            buildingAddress: addresses
         })};`
        }}
      />
      <div className="min-h-screen bg-gray-50">
        <div className="max-w-7xl mx-auto px-4 pt-4">
          <Breadcrumb items={[{ label: development.name }]} />
        </div>
      <div className="bg-gradient-to-r from-blue-900 to-blue-700 text-white">
        <div className="max-w-7xl mx-auto px-4 py-16 text-center">
          <h1 className="text-4xl md:text-5xl font-bold mb-4">{development.name}</h1>
          <p className="text-xl text-blue-100 mb-2">{addresses}</p>
          <p className="text-blue-200">{buildings.length} Buildings - {totalUnits} Total Units</p>
          <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mt-8 max-w-3xl mx-auto">
              <a href="#for-sale" className="bg-white/10 rounded-lg p-4 hover:bg-white/20 transition-colors cursor-pointer"><div className="text-3xl font-bold">{forSaleActive.length}</div><div className="text-blue-200 text-sm">For Sale</div></a>
              <a href="#for-lease" className="bg-white/10 rounded-lg p-4 hover:bg-white/20 transition-colors cursor-pointer"><div className="text-3xl font-bold">{forLeaseActive.length}</div><div className="text-blue-200 text-sm">For Lease</div></a>
              <a href="#sold" className="bg-white/10 rounded-lg p-4 hover:bg-white/20 transition-colors cursor-pointer"><div className="text-3xl font-bold">{soldListings.length}</div><div className="text-blue-200 text-sm">Sold</div></a>
              <a href="#leased" className="bg-white/10 rounded-lg p-4 hover:bg-white/20 transition-colors cursor-pointer"><div className="text-3xl font-bold">{leasedListings.length}</div><div className="text-blue-200 text-sm">Leased</div></a>
            </div>
        </div>
      </div>
      <div className="max-w-7xl mx-auto px-4 py-8">
        <h2 className="text-2xl font-bold text-gray-900 mb-6">Buildings in {development.name}</h2>
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-12">
          {buildings.map((building: any) => {
            const bListings = (allListings || []).filter((l: any) => l.building_id === building.id)
            const bForSale = bListings.filter((l: any) => l.transaction_type === 'For Sale' && l.standard_status === 'Active').length
            const bForLease = bListings.filter((l: any) => l.transaction_type === 'For Lease' && l.standard_status === 'Active').length
            return (
              <div key={building.id} className="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition-shadow">
                <h3 className="font-bold text-lg text-gray-900 mb-1">{building.building_name}</h3>
                <p className="text-gray-600 text-sm mb-3">{building.canonical_address}</p>
                <div className="flex gap-4 text-sm mb-4">
                  <span className="text-green-600 font-medium">{bForSale} For Sale</span>
                  <span className="text-blue-600 font-medium">{bForLease} For Lease</span>
                </div>
                <Link href={'/' + building.slug} className="block w-full text-center px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors">
                  View Building
                </Link>
              </div>
            )
          })}
        </div>
        {agent && <div className="mb-12"><AgentCard agent={agent} source="building_page" buildingId={buildings[0]?.id} buildingName={development.name} buildingAddress={addresses} /></div>}
        <DevelopmentListings
          forSaleActive={forSaleActive}
          forLeaseActive={forLeaseActive}
          soldListings={soldListings}
          leasedListings={leasedListings}
          developmentName={development.name}
          developmentAddresses={addresses}
          agentId={agent?.id || ''}
        />
      </div>
      <DevelopmentSEO
        developmentName={development.name}
        buildings={buildings}
        totalForSale={forSaleActive.length}
        totalForLease={forLeaseActive.length}
        totalSold={soldListings.length}
        totalLeased={leasedListings.length}
        addresses={addresses}
      />
    </div>
    </>
  )
}
