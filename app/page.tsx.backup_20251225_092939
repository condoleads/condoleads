import { headers } from 'next/headers';
import { notFound } from 'next/navigation';
import { createClient } from '@/lib/supabase/server';
import { getAgentFromHost, isCustomDomain } from '@/lib/utils/agent-detection';
import { HomePage } from '@/components/HomePage';
import LandingHeader from '@/components/landing/LandingHeader'
import HeroSection from '@/components/landing/HeroSection'
import EstimatorDemo from '@/components/landing/EstimatorDemo'
import PipelineFlow from '@/components/landing/PipelineFlow'
import BeforeAfter from '@/components/landing/BeforeAfter'
import PreviewGenerator from '@/components/landing/PreviewGenerator'
import FeatureCards from '@/components/landing/FeatureCards'
import DemoEmbed from '@/components/landing/DemoEmbed'
import CommunityApplication from '@/components/landing/CommunityApplication'

// Force dynamic rendering - no caching
export const dynamic = 'force-dynamic';
export const revalidate = 0;

export default async function RootPage() {
  const headersList = headers();
  const host = headersList.get('host') || '';
  
  // Check custom domain first
  let agent = null;
  if (isCustomDomain(host)) {
    agent = await getAgentFromHost(host);
    console.log('?? DEBUG - Custom domain check:', host, 'Agent:', agent?.full_name);
  }
  
  const subdomain = extractSubdomain(host);
  console.log('?? DEBUG - Host:', host, 'Subdomain:', subdomain);
  
  // If no subdomain AND no custom domain agent, show new landing page
  if (!subdomain && !agent) {
    return (
      <>
        <LandingHeader />
        <main className="pt-16">
          <HeroSection />
          <EstimatorDemo />
          <PipelineFlow />
          <BeforeAfter />
          <PreviewGenerator />
          <FeatureCards />
          <DemoEmbed />
          <CommunityApplication />
        </main>
      </>
    );
  }
  
  const supabase = createClient();
  
  console.log(' DEBUG: Subdomain extracted:', subdomain);

  // Fetch agent by subdomain (if not already found via custom domain)
  if (!agent && subdomain) {
    const { data: subdomainAgent, error: agentError } = await supabase
      .from('agents')
      .select('*')
      .eq('subdomain', subdomain)
      .eq('is_active', true)
      .single();
    
    console.log(' DEBUG: Agent query result:', { agent: subdomainAgent, agentError });
    agent = subdomainAgent;
  }
  
  if (!agent) notFound();

  // Check if this is a manager site (team site)
  const isTeamSite = agent.can_create_children === true;
  let teamAgents: any[] = [];
  let allAgentIds: string[] = [agent.id];

  if (isTeamSite) {
    // Get all agents under this manager
    const { data: childAgents } = await supabase
      .from('agents')
      .select('id, full_name, slug, email, cell_phone, profile_photo_url, bio, title')
      .eq('parent_id', agent.id)
      .eq('is_active', true);
    
    teamAgents = childAgents || [];
    allAgentIds = [agent.id, ...teamAgents.map(a => a.id)];
    console.log(' DEBUG: Team site detected, agents:', allAgentIds.length);
  }

  // Fetch buildings for all relevant agents (team or solo)
  const { data: agentBuildings } = await supabase
    .from('agent_buildings')
    .select(`
      is_featured,
      agent_id,
      buildings (
          id,
          building_name,
          slug,
          canonical_address,
          street_number,
          street_name,
          city_district,
          development_id,
          cover_photo_url,
          gallery_photos
        ),
      agents (
        id,
        full_name,
        slug,
        profile_photo_url
      )
    `)
    .in('agent_id', allAgentIds)
    .order('is_featured', { ascending: false });

  // Fetch agent's assigned developments
  const { data: agentDevelopments } = await supabase
    .from('development_agents')
    .select(`
      agent_id,
      developments (
          id,
          name,
          slug,
          cover_photo_url,
          gallery_photos
        ),
        agents (
        id,
        full_name,
        slug,
        profile_photo_url
      )
    `)
    .in('agent_id', allAgentIds);

  // Get buildings from assigned developments
  const developmentIds = (agentDevelopments || [])
    .map((ad: any) => ad.developments?.id)
    .filter(Boolean);

  let developmentBuildings: any[] = [];
  if (developmentIds.length > 0) {
    const { data: devBuildings } = await supabase
        .from('buildings')
        .select('id, building_name, slug, canonical_address, street_number, street_name, city_district, development_id, cover_photo_url, gallery_photos')
        .in('development_id', developmentIds);
    developmentBuildings = devBuildings || [];
  }

  // Combine direct and development buildings, avoiding duplicates
  const directBuildingIds = new Set((agentBuildings || []).map((ab: any) => ab.buildings?.id));
  const combinedBuildings = [
    ...(agentBuildings || []).map((ab: any) => ({ 
      ...ab.buildings, 
      is_featured: ab.is_featured, 
      fromDevelopment: false,
      assigned_agent: ab.agents || null
    })),
    ...developmentBuildings
      .filter((b: any) => !directBuildingIds.has(b.id))
      .map((b: any) => ({ ...b, is_featured: false, fromDevelopment: true }))
  ];

  console.log(' DEBUG: Found buildings:', combinedBuildings.length);

  // Get listing counts and photos for each building
  const buildingsWithCounts = await Promise.all(
    combinedBuildings.map(async (building) => {

      // Get listings for counts
      const { data: listings } = await supabase
        .from('mls_listings')
        .select('id, transaction_type, standard_status')
        .eq('building_id', building.id);

      const forSale = listings?.filter(
        l => l.transaction_type === 'For Sale' && l.standard_status === 'Active'
      ).length || 0;
      const forLease = listings?.filter(
        l => l.transaction_type === 'For Lease' && l.standard_status === 'Active'
      ).length || 0;

      // Get first photo from building's listings
      const { data: photo } = await supabase
        .from('media')
        .select('media_url')
        .in('listing_id', listings?.map(l => l.id) || [])
        .eq('variant_type', 'large')
        .order('preferred_photo_yn', { ascending: false })
        .order('order_number', { ascending: true })
        .limit(1);

      return {
        ...building,
        forSale,
        forLease,
        isFeatured: building.is_featured,
        fromDevelopment: building.fromDevelopment,
        photoUrl: building.cover_photo_url || photo?.[0]?.media_url || null,
          galleryPhotos: building.gallery_photos || [],
          assigned_agent: building.assigned_agent || null
      };
    })
  );

  console.log(' DEBUG: Buildings with counts:', buildingsWithCounts.length);

  return (
    <>
      <script
        dangerouslySetInnerHTML={{
          __html: `window.__AGENT_DATA__ = ${JSON.stringify({
            full_name: agent.full_name,
            email: agent.email,
            phone: agent.cell_phone,
            brokerage_name: agent.brokerage_name,
            brokerage_address: agent.brokerage_address,
            title: agent.title
          })};`
        }}
      />
      <HomePage
        agent={agent}
        buildings={buildingsWithCounts.filter((b: any) => !b.fromDevelopment)}
        isTeamSite={isTeamSite}
        teamAgents={teamAgents}
        developments={(agentDevelopments || []).map((ad: any) => {
          const devBuildings = developmentBuildings.filter((b: any) => b.development_id === ad.developments?.id);
          const devBuildingsWithCounts = buildingsWithCounts.filter((b: any) => b.development_id === ad.developments?.id);
          const buildingWithPhoto = devBuildingsWithCounts.find((b: any) => b.photoUrl);
          const addresses = devBuildings.map((b: any) => b.canonical_address).join(' & ');
          const forSale = devBuildingsWithCounts.reduce((sum: number, b: any) => sum + (b.forSale || 0), 0);
          const forLease = devBuildingsWithCounts.reduce((sum: number, b: any) => sum + (b.forLease || 0), 0);
          return {
              id: ad.developments?.id,
              name: ad.developments?.name,
              slug: ad.developments?.slug,
              buildingCount: devBuildings.length,
              photoUrl: ad.developments?.cover_photo_url || buildingWithPhoto?.photoUrl || null,
              galleryPhotos: ad.developments?.gallery_photos || [],
              addresses: addresses,
              forSale: forSale,
              forLease: forLease,
              assigned_agent: ad.agents || null
            };
        }).filter((d: any) => d.id)}
      />
    </>
  );
}

function extractSubdomain(host: string) {
  // Production: extract subdomain from condoleads.ca
  if (host.endsWith('.condoleads.ca') || host === 'condoleads.ca') {
    const parts = host.split('.');
    // condoleads.ca = no subdomain (2 parts)
    // mary.condoleads.ca = subdomain 'mary' (3 parts)
    if (parts.length === 2) {
      return null; // Root domain, no subdomain
    }
    if (parts.length >= 3 && parts[1] === 'condoleads') {
        const potentialSubdomain = parts[0];
        // Filter out 'www' - it's not a real subdomain
        if (potentialSubdomain === 'www') {
          return null;
        }
        return potentialSubdomain; // Return subdomain
      }
  }

  // Development: use DEV_SUBDOMAIN environment variable
  if (host.includes('localhost') || host.includes('vercel.app')) {
    return process.env.DEV_SUBDOMAIN || null;
  }

  return null;
}

// Generate metadata dynamically based on agent
export async function generateMetadata() {
  const headersList = headers();
  const host = headersList.get('host') || '';
  const subdomain = extractSubdomain(host);
  console.log('?? DEBUG - Host:', host, 'Subdomain:', subdomain);

  if (!subdomain) {
    return {
      title: 'CondoLeads - Get Your AI-Powered Condo Leads Funnel Today',
      description: 'Stop sharing leads with competitors. Get your branded website with AI estimates that turn curious buyers into exclusive clients.'
    };
  }

  const supabase = createClient();
  const { data: agent } = await supabase
    .from('agents')
    .select('full_name, bio')
    .eq('subdomain', subdomain)
    .eq('is_active', true)
    .single();

  if (!agent) {
    return { title: 'Agent Not Found' };
  }

  return {
    title: `${agent.full_name} - Toronto Condo Specialist`,
    description: agent.bio || `Find luxury Toronto condos with ${agent.full_name}. Exclusive access to premium buildings.`,
  };
}