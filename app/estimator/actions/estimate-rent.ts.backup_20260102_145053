// app/estimator/actions/estimate-rent.ts
'use server'

import { findComparablesRentals } from '@/lib/estimator/comparable-matcher-rentals'
import { calculateEstimate } from '@/lib/estimator/statistical-calculator'
import { getAIInsights } from '@/lib/estimator/ai-insights'
import { EstimateResult, UnitSpecs, ADJUSTMENT_VALUES_LEASE } from '@/lib/estimator/types'
import { createClient as createServerClient } from '@supabase/supabase-js'

function createServiceClient() {
  return createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.SUPABASE_SERVICE_ROLE_KEY!
  )
}

/**
 * Server action to estimate monthly rent
 * Uses 5-tier matching: BINGO -> BINGO-ADJ -> RANGE -> RANGE-ADJ -> CONTACT
 * 
 * Value Priority: Building-specific > Universal Default > System Hardcoded
 */
export async function estimateRent(
  specs: UnitSpecs,
  includeAI: boolean = false
): Promise<{ success: boolean; data?: EstimateResult & { parkingCost?: number; lockerCost?: number }; error?: string }> {
  try {
    const supabase = createServiceClient()

    // Fetch building-specific values
    const { data: building } = await supabase
      .from('buildings')
      .select('parking_value_lease, locker_value_lease')
      .eq('id', specs.buildingId)
      .single()

    // Fetch universal defaults from system_settings
    const { data: systemSettings } = await supabase
      .from('system_settings')
      .select('setting_value')
      .eq('setting_key', 'estimator_defaults')
      .single()

    const universalDefaults = systemSettings?.setting_value || {}

    // Priority: Building-specific > Universal Default > System Hardcoded
    const parkingValueLease = 
      building?.parking_value_lease ?? 
      universalDefaults.parking_value_lease ?? 
      ADJUSTMENT_VALUES_LEASE.PARKING_PER_SPACE

    const lockerValueLease = 
      building?.locker_value_lease ?? 
      universalDefaults.locker_value_lease ?? 
      ADJUSTMENT_VALUES_LEASE.LOCKER

    // Step 1: Find comparable leases using tiered matching
    const matchResult = await findComparablesRentals(specs, { parkingPerSpace: parkingValueLease, locker: lockerValueLease })
    console.log(`[Rental Estimator] Found ${matchResult.comparables.length} comparables at tier: ${matchResult.tier}`)

    // Step 2: Calculate estimate based on tier
    const estimate = calculateEstimate(matchResult)

    // Step 3: Calculate parking cost using priority values
    const parkingCost = specs.parking > 0 ? specs.parking * parkingValueLease : 0

    // Step 4: Calculate locker cost using priority values
    const lockerCost = specs.hasLocker ? lockerValueLease : 0

    // Step 5: Add AI insights if requested and we have a price
    let aiInsights = undefined
    if (includeAI && estimate.showPrice && estimate.estimatedPrice > 0) {
      try {
        aiInsights = await getAIInsights(specs, estimate.estimatedPrice, matchResult.comparables)
      } catch (aiError) {
        console.log('AI insights unavailable:', aiError)
      }
    }

    return {
      success: true,
      data: {
        ...estimate,
        parkingCost,
        lockerCost,
        aiInsights
      }
    }
  } catch (error) {
    console.error('Error estimating rent:', error)
    return {
      success: false,
      error: error instanceof Error ? error.message : 'Failed to calculate estimate'
    }
  }
}