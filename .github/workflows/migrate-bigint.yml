name: DB Migration - Bigint
on:
  workflow_dispatch:

jobs:
  migrate:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - run: npm install pg
      - name: Run migration
        env:
          DATABASE_URL: postgresql://postgres.htbyftlpbtpnrkbtxawj:${{ secrets.DB_PASSWORD }}@aws-1-ca-central-1.pooler.supabase.com:5432/postgres
        run: |
          node -e "
          const { Client } = require('pg');
          async function alterCol(col) {
            const c = new Client({ connectionString: process.env.DATABASE_URL, ssl: { rejectUnauthorized: false } });
            await c.connect();
            await c.query('SET statement_timeout = 0');
            console.log('Altering ' + col + '...');
            await c.query('ALTER TABLE mls_listings ALTER COLUMN ' + col + ' TYPE bigint');
            console.log('  Done');
            await c.end();
          }
          async function run() {
            const cols = ['close_price','original_list_price','previous_list_price','close_price_hold'];
            for (const col of cols) {
              try { await alterCol(col); } 
              catch(e) { console.error('  Failed: ' + e.message); }
            }
            console.log('Complete');
          }
          run();
          "
