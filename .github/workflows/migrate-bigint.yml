name: DB Migration - Bigint
on:
  workflow_dispatch:

env:
  DATABASE_URL: postgresql://postgres:${{ secrets.DB_PASSWORD }}@db.htbyftlpbtpnrkbtxawj.supabase.co:5432/postgres

jobs:
  migrate:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - run: npm install pg
      - name: Run migration
        run: |
          node -e "
          const { Client } = require('pg');
          async function run() {
            const client = new Client({ connectionString: process.env.DATABASE_URL, ssl: { rejectUnauthorized: false } });
            await client.connect();
            console.log('Connected');
            await client.query('SET statement_timeout = 600000');
            const cols = ['close_price','original_list_price','previous_list_price','close_price_hold'];
            for (const col of cols) {
              console.log('Altering ' + col + '...');
              try {
                await client.query('ALTER TABLE mls_listings ALTER COLUMN ' + col + ' TYPE bigint');
                console.log('  Done');
              } catch(e) { console.error('  Failed: ' + e.message); }
            }
            await client.end();
            console.log('Complete');
          }
          run();
          "
